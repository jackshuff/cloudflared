#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e  # Exit immediately if a command fails

echo "-----> Installing Cloudflared..."

BUILD_DIR=$1
CLOUDFLARED_DIR="$BUILD_DIR/cloudflared"
CLOUDFLARED_CONFIG_DIR="$BUILD_DIR/.cloudflared"

# Ensure directories exist
mkdir -p "$CLOUDFLARED_DIR"
mkdir -p "$CLOUDFLARED_CONFIG_DIR"

# Download latest Cloudflared binary
echo "       Downloading Cloudflared..."
curl -fsSL -o "$CLOUDFLARED_DIR/cloudflared" https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64

# Make the binary executable
chmod +x "$CLOUDFLARED_DIR/cloudflared"

echo "-----> Cloudflared installation complete."

# Verify installation
echo "       Verifying Cloudflared installation..."
"$CLOUDFLARED_DIR/cloudflared" version || { echo "       Error: Cloudflared did not install correctly"; exit 1; }

echo "-----> Generating Cloudflared config.yml dynamically..."

# Generate config.yml with HEROKU_APP_NAME and PORT
cat <<EOF > "$CLOUDFLARED_CONFIG_DIR/config.yml"
ingress:
  - hostname: \${HEROKU_APP_NAME}.combinepensions.com
    service: http://localhost:\${PORT}
  - service: http_status:404
EOF

echo "-----> Cloudflared config.yml generated:"
cat "$CLOUDFLARED_CONFIG_DIR/config.yml"

echo "-----> Cloudflared is successfully installed and configured."
